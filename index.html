<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Impulse Game üöÄ</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{
  margin:0;
  background:linear-gradient(135deg,#0d1a36,#081025);
  color:#edf2f7;
  font-family:Segoe UI;
  text-align:center;
  overflow-x:hidden;
}

h1{margin-top:12px;font-size:26px;}

.stats{font-size:14px;margin:6px 0;}

.progress-container{
  width:85%;
  height:18px;
  background:rgba(255,255,255,0.15);
  border-radius:10px;
  margin:8px auto;
  overflow:hidden;
}

.progress-inner{
  height:100%;
  background:linear-gradient(90deg,#22c55e,#3b82f6,#6366f1);
  width:0%;
  transition:0.4s;
}

.screen{display:none;padding-bottom:80px;}
.screen.active{display:block;}

.section{
  margin:12px auto;
  width:90%;
  padding:14px;
  background:rgba(255,255,255,0.08);
  border-radius:14px;
}

button{
  margin:6px;
  padding:14px 22px;
  font-size:16px;
  border-radius:12px;
  border:none;
  color:white;
  font-weight:bold;
  cursor:pointer;
}

.btn-main{background:#22c55e;}
.btn-blue{background:#3b82f6;}

.navbar{
  position:fixed;
  bottom:0;
  width:100%;
  display:flex;
  justify-content:space-around;
  background:#0f172a;
  padding:10px 0;
}

.navbar button{
  background:none;
  border:none;
  color:white;
  font-size:13px;
}

.combo{font-size:13px;color:#22c55e;}

.particle{
  position:absolute;
  width:6px;height:6px;
  background:#22c55e;
  border-radius:50%;
  animation:rise 1s ease-out forwards;
}
@keyframes rise{
  from{opacity:1;transform:translateY(0);}
  to{opacity:0;transform:translateY(-60px);}
}
</style>
</head>

<body>

<h1>Impulse Game üöÄ</h1>

<div class="stats">
ü™ô <span id="coins">0</span> |
‚ö° <span id="energy">0</span>/100 |
‚≠ê <span id="level">1</span> |
üî• <span id="xp">0</span>
</div>

<div class="combo">
‚ö° Combo: x<span id="combo">1</span>
</div>

<div class="progress-container">
<div id="xpBar" class="progress-inner"></div>
</div>

<div id="home" class="screen active">
<button class="btn-main" onclick="clickGame()">TOCAR!</button>
</div>

<div id="upgrades" class="screen">
<div class="section">
<h3>Loja</h3>
<div id="shopArea"></div>
</div>
</div>

<div id="missions" class="screen">
<div class="section">
<h3>Miss√µes</h3>
<div id="missionList"></div>
</div>
</div>

<div id="ranking" class="screen">
<div class="section">
<h3>Ranking Global</h3>
<div id="rankList">Carregando...</div>
<button class="btn-blue" onclick="sendRank()">Enviar Score</button>
</div>
</div>

<div class="navbar">
<button onclick="show('home')">Home</button>
<button onclick="show('upgrades')">Loja</button>
<button onclick="show('missions')">Miss√µes</button>
<button onclick="show('ranking')">Ranking</button>
</div>

<script>

const backendURL="https://script.google.com/macros/s/AKfycbxYj0ldxCreMr31GCFHbZmm9VTPRh-Lug3jdajGldnO80TtfYrmhHota2OstiQ2WLFE/exec";

const player={
  name:"",
  coins:0,
  energy:100,
  level:1,
  xp:0,
  clicks:0,
  combo:1,
  lastClick:0,
  lastDaily:"",
  upgrades:{power:1,speed:0},
  missions:{active:[],history:[]}
};

function save(){localStorage.setItem("impulse_stable",JSON.stringify(player));}
function load(){const d=localStorage.getItem("impulse_stable");if(d)Object.assign(player,JSON.parse(d));}

function xpNeeded(){return Math.floor(60*Math.pow(player.level,1.2));}

function updateUI(){
  coins.innerText=player.coins;
  energy.innerText=player.energy;
  level.innerText=player.level;
  xp.innerText=player.xp;
  combo.innerText=player.combo;
  xpBar.style.width=Math.min((player.xp/xpNeeded())*100,100)+"%";
  renderShop();
}

function show(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id==="ranking")fetchRank();
  if(id==="missions")renderMissions();
}

function clickGame(){
  const now=Date.now();

  if(now-player.lastClick<120){return;} // anti-macro

  if(player.energy<=0)return;

  if(now-player.lastClick<800-player.upgrades.speed*50){
    player.combo=Math.min(player.combo+1,6);
  }else{
    player.combo=1;
  }

  player.lastClick=now;

  const gain=Math.floor(player.upgrades.power*player.combo);
  player.coins+=gain;
  player.energy--;
  player.xp+=1+player.combo;
  player.clicks++;

  createParticles();
  levelUp();
  checkMissions();
  save();updateUI();
}

function levelUp(){
  if(player.xp>=xpNeeded()){
    player.level++;
    player.energy=Math.min(player.energy+20,100);
    player.xp=0;
  }
}

function renderShop(){
  const powerCost=Math.floor(100*Math.pow(1.25,player.upgrades.power));
  const speedCost=Math.floor(150*Math.pow(1.3,player.upgrades.speed));

  shopArea.innerHTML=`
    <p>Power: ${player.upgrades.power}</p>
    <button onclick="buy('power',${powerCost})">Power +1 (${powerCost})</button>
    <p>Speed: ${player.upgrades.speed}</p>
    <button onclick="buy('speed',${speedCost})">Speed +1 (${speedCost})</button>
  `;
}

function buy(type,cost){
  if(player.coins<cost)return;
  player.coins-=cost;
  player.upgrades[type]++;
  save();updateUI();
}

function genMission(){
  const goalClicks=100+Math.floor(Math.random()*200);
  const goalCoins=200+Math.floor(Math.random()*400);
  const goalLevel=2+Math.floor(Math.random()*4);

  const types=[
    {text:`Fa√ßa ${goalClicks} cliques`,check:()=>player.clicks>=goalClicks},
    {text:`Ganhe ${goalCoins} moedas`,check:()=>player.coins>=goalCoins},
    {text:`Alcance n√≠vel ${goalLevel}`,check:()=>player.level>=goalLevel}
  ];

  return {...types[Math.floor(Math.random()*types.length)],complete:false};
}

function checkMissions(){
  if(player.missions.active.length<2){
    player.missions.active=[genMission(),genMission()];
  }

  player.missions.active.forEach(m=>{
    if(!m.complete && m.check()){
      m.complete=true;
      player.coins+=150;
      player.missions.history.push(m.text);
    }
  });
}

function renderMissions(){
  missionList.innerHTML=player.missions.active.map(m=>
    `<p>${m.complete?"‚úîÔ∏è":"‚ùå"} ${m.text}</p>`
  ).join("");
}

async function fetchRank(){
  try{
    const r=await fetch(backendURL);
    const d=await r.json();
    rankList.innerHTML="<ol>"+d.slice(0,10).map(p=>
      `<li>${p.name} ‚Äî ‚≠ê ${p.score}</li>`
    ).join("")+"</ol>";
  }catch{
    rankList.innerHTML="Erro ao carregar ranking";
  }
}

async function sendRank(){
  const name=prompt("Digite seu nick:");
  if(!name)return;
  player.name=name;save();

  try{
    await fetch(backendURL,{
      method:"POST",
      body:JSON.stringify({
        name:player.name,
        coins:player.coins,
        level:player.level,
        xp:player.xp
      })
    });
  }catch{}
  fetchRank();
}

function createParticles(){
  for(let i=0;i<4;i++){
    const p=document.createElement("div");
    p.className="particle";
    p.style.left=(50+Math.random()*60-30)+"%";
    document.body.appendChild(p);
    setTimeout(()=>p.remove(),1000);
  }
}

function dailyReward(){
  const today=new Date().toISOString().slice(0,10);
  if(player.lastDaily!==today){
    player.lastDaily=today;
    player.coins+=200;
  }
}

setInterval(()=>{
  if(player.energy<100){
    player.energy++;
    save();updateUI();
  }
},5000);

load();
dailyReward();
updateUI();
Telegram.WebApp.expand();

</script>
</body>
</html>
