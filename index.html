<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Impulse Evolution üöÄ</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  body { background:#071e3d; color:#fff; font-family:Arial,sans-serif; text-align:center; padding-top:18px; }
  button { padding:14px 28px; font-size:20px; border:none; border-radius:9px; margin:8px; cursor:pointer; }
  .btn-main{background:#10b981;color:#fff;}
  .btn-blue{background:#2563eb;color:#fff;}
  .btn-disabled{background:#4b5563;color:#d1d5db;cursor:not-allowed;}
  #menuArea{margin-top:18px;}
  .stats{font-size:18px;margin:10px;}
  #notif {font-size:20px; margin-top:12px; color:#ffeb3b;}
  #rankList li { text-align:left; font-size:18px; }
</style>
</head>
<body>

<h1>Impulse Evolution üöÄ</h1>

<div class="stats">
  Moedas: <span id="coinsDisplay">0</span><br>
  Energia: <span id="energyDisplay">0</span>/100  
  | N√≠vel: <span id="levelDisplay">1</span>  
  | XP: <span id="xpDisplay">0</span>
</div>

<button class="btn-main" id="btnClick" onclick="handleClick()">TOCAR!</button>
<button class="btn-blue" onclick="openMenu('upgrades')">Upgrades</button>
<button class="btn-blue" onclick="openMenu('missions')">Miss√µes</button>
<button class="btn-blue" onclick="openMenu('ranking')">Ranking Global</button>

<div id="notif"></div>
<div id="menuArea"></div>

<script>

// ===========================
// ‚öôÔ∏è CONFIGURA√á√ÉO
// ===========================
const sheetID = "12qXDvr7ZooG9qk-6qN8ZO9eDGGFfITkiPKz36lMLgGA";
const gURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?`;

// ===========================
// üßæ DADOS DO JOGADOR
// ===========================
const player = {
  coins: 0,
  energy: 100,
  level: 1,
  xp: 0,
  upgrades: { power:1, speed:0 },
  missions: {
    clicks: 0,
    goals: { play10: false, level5: false }
  }
};

// ===========================
// üíæ LOCAL STORAGE
// ===========================
function saveAll(){ localStorage.setItem("impulse_evo", JSON.stringify(player)); }
function loadAll(){
  const raw = localStorage.getItem("impulse_evo");
  if(raw){ Object.assign(player, JSON.parse(raw)); }
}

// ===========================
// üïπÔ∏è GAMEPLAY
// ===========================
function handleClick(){
  if(player.energy <=0){ notify("Sem energia!"); return; }
  player.coins += player.upgrades.power;
  player.energy--;
  player.xp++;
  player.missions.clicks++;
  
  checkLevelUp();
  checkMissions();
  
  saveAll();
  updateDisplay();
}

// ===========================
// ‚≠ê NIVELAMENTO
// ===========================
function checkLevelUp(){
  if(player.xp >= player.level * 60){
    player.level++;
    player.energy = Math.min(player.energy + 20, 100);
    player.xp = 0;
    notify(`üéâ UP! N√≠vel ${player.level}`);
  }
}

// ===========================
// üîî NOTIFICA√á√ïES
// ===========================
function notify(msg){
  document.getElementById("notif").innerText = msg;
  setTimeout(()=> document.getElementById("notif").innerText = "", 2000);
}

// ===========================
// üîÑ DISPLAY
// ===========================
function updateDisplay(){
  document.getElementById("coinsDisplay").innerText = player.coins;
  document.getElementById("energyDisplay").innerText = player.energy;
  document.getElementById("levelDisplay").innerText = player.level;
  document.getElementById("xpDisplay").innerText = player.xp;
}

// ===========================
// üì¶ MENUS
// ===========================
function openMenu(type){
  let html = "";
  
  if(type=="upgrades"){
    html += "<h3>Upgrades</h3>";
    html += btn("Power +1 (50)", player.coins>=50, ()=>buy("power",50));
    html += btn("Speed +20 energia (30)", player.coins>=30, ()=>buy("speed",30));
  }
  
  if(type=="missions"){
    html += "<h3>Miss√µes</h3>";
    html += `<p>‚Ä¢ Clique 100√ó: ${player.missions.goals.play10? "‚úîÔ∏è":"‚ùå"}</p>`;
    html += `<p>‚Ä¢ Chegar n√≠vel 5: ${player.missions.goals.level5? "‚úîÔ∏è":"‚ùå"}</p>`;
  }
  
  if(type=="ranking"){
    html += "<h3>Ranking Global por N√≠vel</h3>";
    html += "<div id='rankList'>Carregando...</div>";
    fetchRank();
  }
  
  document.getElementById("menuArea").innerHTML = html;
}

// ===========================
// üí∞ UPGRADES
// ===========================
function btn(text, ok, action){
  return `<button class="${ok?'btn-main':'btn-disabled'}" ${ok? `onclick="${action.name}()"`: ""}>${text}</button><br>`;
}

function buy(type,cost){
  if(player.coins < cost){ notify("Sem moedas suficientes"); return; }
  player.coins -= cost;
  player.upgrades[type]++;
  saveAll(); 
  openMenu("upgrades");
  updateDisplay();
  notify("Comprado!");
}

// ===========================
// üèÅ MISS√ïES
// ===========================
function checkMissions(){
  if(player.missions.clicks >= 100 && !player.missions.goals.play10){
    player.missions.goals.play10 = true;
    player.coins += 50;
    notify("Miss√£o conclu√≠da 100 cliques! +50 moedas");
  }
  if(player.level >= 5 && !player.missions.goals.level5){
    player.missions.goals.level5 = true;
    player.coins += 100;
    notify("Miss√£o n√≠vel 5 conclu√≠da! +100 moedas");
  }
}

// ===========================
// üìä RANKING GLOBAL
// ===========================
async function fetchRank(){
  const query = encodeURIComponent("select A, C order by C desc limit 10");
  const url = `${gURL}tq=${query}`;
  
  try {
    const res = await fetch(url);
    const text = await res.text();
    const json = text.substring(text.indexOf("{"), text.lastIndexOf("}")+1);
    const data = JSON.parse(json).table.rows;
    
    let out = "<ol>";
    data.forEach(r => {
      const nome = r.c[0]? r.c[0].v : "‚Äî";
      const lvl = r.c[1]? r.c[1].v : 0;
      out += `<li>${nome} ‚Äî N√≠vel ${lvl}</li>`;
    });
    out += "</ol>";
    document.getElementById("rankList").innerHTML = out;
  } catch(err){
    document.getElementById("rankList").innerHTML = "Erro ao carregar ranking.";
  }
}

// ===========================
// ‚è±Ô∏è ENERGIA
// ===========================
setInterval(()=>{
  if(player.energy < 100){
    player.energy++;
    saveAll();
    updateDisplay();
  }
}, 5000);

// ===========================
// üü¢ INICIALIZA√á√ÉO
// ===========================
loadAll();
Telegram.WebApp.expand();
updateDisplay();

</script>
</body>
</html>

